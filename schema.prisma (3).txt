// Prisma Schema for FlowFit SaaS
// Production-ready database schema with relationships and indexes

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// USER & AUTHENTICATION
// ============================================

enum Role {
  USER
  ADMIN
  COACH
}

enum SubscriptionStatus {
  ACTIVE
  CANCELLED
  EXPIRED
  TRIAL
  PENDING
}

enum SubscriptionPlan {
  FREE
  PRO
  PREMIUM
}

model User {
  id                String        @id @default(uuid())
  email             String        @unique
  password          String
  name              String
  role              Role          @default(USER)
  isEmailVerified   Boolean       @default(false)
  emailVerifyToken  String?
  resetPasswordToken String?
  resetPasswordExpires DateTime?
  lastLogin         DateTime?
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt

  // Relations
  profile           Profile?
  subscription      Subscription?
  workoutLogs       WorkoutLog[]
  programEnrollments ProgramEnrollment[]
  achievements      UserAchievement[]
  refreshTokens     RefreshToken[]
  metrics           UserMetrics[]
  favorites         FavoriteWorkout[]

  @@index([email])
  @@index([role])
  @@map("users")
}

model RefreshToken {
  id          String   @id @default(uuid())
  token       String   @unique
  userId      String
  expiresAt   DateTime
  createdAt   DateTime @default(now())

  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
  @@map("refresh_tokens")
}

model Profile {
  id              String   @id @default(uuid())
  userId          String   @unique
  firstName       String?
  lastName        String?
  dateOfBirth     DateTime?
  gender          String?
  height          Float?    // in cm
  weight          Float?    // in kg
  targetWeight    Float?
  fitnessGoal     String?
  fitnessLevel    String?   // BEGINNER, INTERMEDIATE, ADVANCED
  timezone        String?
  avatarUrl       String?
  bio             String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("profiles")
}

// ============================================
// SUBSCRIPTION & BILLING
// ============================================

model Subscription {
  id                String              @id @default(uuid())
  userId            String              @unique
  plan              SubscriptionPlan    @default(FREE)
  status            SubscriptionStatus  @default(TRIAL)
  currentPeriodStart DateTime?
  currentPeriodEnd  DateTime?
  cancelAtPeriodEnd Boolean             @default(false)
  stripeCustomerId  String?             @unique
  stripeSubscriptionId String?          @unique
  mpesaPhoneNumber  String?
  trialEndsAt       DateTime?
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt

  user              User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  payments          Payment[]

  @@index([userId])
  @@index([status])
  @@map("subscriptions")
}

model Payment {
  id              String   @id @default(uuid())
  subscriptionId  String
  amount          Float
  currency        String   @default("USD")
  status          String   // SUCCESS, PENDING, FAILED
  paymentMethod   String   // STRIPE, MPESA, PAYPAL
  transactionId   String?  @unique
  metadata        Json?
  createdAt       DateTime @default(now())

  subscription    Subscription @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)

  @@index([subscriptionId])
  @@index([status])
  @@map("payments")
}

// ============================================
// EXERCISE LIBRARY
// ============================================

enum Difficulty {
  BEGINNER
  INTERMEDIATE
  ADVANCED
  ELITE
}

model Exercise {
  id              String      @id @default(uuid())
  name            String      @unique
  slug            String      @unique
  description     String
  instructions    String[]
  difficulty      Difficulty
  category        String      // CARDIO, STRENGTH, FLEXIBILITY, CORE
  targetMuscles   String[]
  equipment       String[]
  duration        Int?        // estimated duration in seconds
  caloriesPerMin  Float?
  videoUrl        String?
  imageUrl        String?
  thumbnailUrl    String?
  isActive        Boolean     @default(true)
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt

  // Relations
  workoutExercises WorkoutExercise[]
  workoutLogs      WorkoutLog[]
  favorites        FavoriteWorkout[]

  @@index([difficulty])
  @@index([category])
  @@index([slug])
  @@map("exercises")
}

model FavoriteWorkout {
  id          String   @id @default(uuid())
  userId      String
  exerciseId  String
  createdAt   DateTime @default(now())

  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  exercise    Exercise @relation(fields: [exerciseId], references: [id], onDelete: Cascade)

  @@unique([userId, exerciseId])
  @@index([userId])
  @@map("favorite_workouts")
}

// ============================================
// WORKOUT PROGRAMS
// ============================================

model Program {
  id              String      @id @default(uuid())
  name            String
  slug            String      @unique
  description     String
  difficulty      Difficulty
  durationWeeks   Int
  daysPerWeek     Int
  minutesPerDay   Int
  category        String
  isPremium       Boolean     @default(false)
  imageUrl        String?
  goals           String[]
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt

  // Relations
  weeks           ProgramWeek[]
  enrollments     ProgramEnrollment[]

  @@index([difficulty])
  @@index([isPremium])
  @@map("programs")
}

model ProgramWeek {
  id              String   @id @default(uuid())
  programId       String
  weekNumber      Int
  title           String?
  description     String?
  createdAt       DateTime @default(now())

  program         Program  @relation(fields: [programId], references: [id], onDelete: Cascade)
  days            ProgramDay[]

  @@unique([programId, weekNumber])
  @@map("program_weeks")
}

model ProgramDay {
  id              String   @id @default(uuid())
  weekId          String
  dayNumber       Int
  title           String?
  restDay         Boolean  @default(false)
  createdAt       DateTime @default(now())

  week            ProgramWeek @relation(fields: [weekId], references: [id], onDelete: Cascade)
  exercises       WorkoutExercise[]

  @@unique([weekId, dayNumber])
  @@map("program_days")
}

model WorkoutExercise {
  id              String   @id @default(uuid())
  dayId           String
  exerciseId      String
  orderIndex      Int
  sets            Int?
  reps            Int?
  durationSeconds Int?
  restSeconds     Int?
  notes           String?
  createdAt       DateTime @default(now())

  day             ProgramDay @relation(fields: [dayId], references: [id], onDelete: Cascade)
  exercise        Exercise   @relation(fields: [exerciseId], references: [id], onDelete: Cascade)

  @@map("workout_exercises")
}

model ProgramEnrollment {
  id              String   @id @default(uuid())
  userId          String
  programId       String
  startDate       DateTime @default(now())
  currentWeek     Int      @default(1)
  currentDay      Int      @default(1)
  completedDays   Int      @default(0)
  isActive        Boolean  @default(true)
  completedAt     DateTime?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  program         Program  @relation(fields: [programId], references: [id], onDelete: Cascade)

  @@unique([userId, programId])
  @@index([userId])
  @@index([isActive])
  @@map("program_enrollments")
}

// ============================================
// WORKOUT TRACKING & PROGRESS
// ============================================

model WorkoutLog {
  id              String   @id @default(uuid())
  userId          String
  exerciseId      String
  date            DateTime @default(now())
  duration        Int      // in seconds
  sets            Int?
  reps            Int?
  caloriesBurned  Float?
  heartRate       Int?
  difficulty      String?
  notes           String?
  completed       Boolean  @default(true)
  createdAt       DateTime @default(now())

  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  exercise        Exercise @relation(fields: [exerciseId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([date])
  @@index([exerciseId])
  @@map("workout_logs")
}

model UserMetrics {
  id              String   @id @default(uuid())
  userId          String
  date            DateTime @default(now())
  weight          Float?   // kg
  bodyFat         Float?   // percentage
  muscleMass      Float?   // kg
  bmi             Float?
  restingHeartRate Int?
  notes           String?
  createdAt       DateTime @default(now())

  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([date])
  @@map("user_metrics")
}

// ============================================
// GAMIFICATION
// ============================================

model Achievement {
  id              String   @id @default(uuid())
  name            String   @unique
  description     String
  icon            String
  category        String   // STREAK, MILESTONE, EXERCISE, PROGRAM
  requirement     Json     // flexible JSON for conditions
  points          Int      @default(0)
  createdAt       DateTime @default(now())

  users           UserAchievement[]

  @@map("achievements")
}

model UserAchievement {
  id              String   @id @default(uuid())
  userId          String
  achievementId   String
  unlockedAt      DateTime @default(now())

  user            User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  achievement     Achievement @relation(fields: [achievementId], references: [id], onDelete: Cascade)

  @@unique([userId, achievementId])
  @@index([userId])
  @@map("user_achievements")
}

model Streak {
  id              String   @id @default(uuid())
  userId          String   @unique
  currentStreak   Int      @default(0)
  longestStreak   Int      @default(0)
  lastWorkoutDate DateTime?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@map("streaks")
}

// ============================================
// ANALYTICS & REPORTING
// ============================================

model DailyStats {
  id              String   @id @default(uuid())
  date            DateTime @unique @default(now())
  totalUsers      Int      @default(0)
  activeUsers     Int      @default(0)
  newUsers        Int      @default(0)
  totalWorkouts   Int      @default(0)
  revenue         Float    @default(0)
  createdAt       DateTime @default(now())

  @@index([date])
  @@map("daily_stats")
}
