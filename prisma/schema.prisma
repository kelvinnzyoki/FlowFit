generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// CORE MODELS (Added to fix your errors)
// ============================================

model User {
  id               String              @id @default(uuid())
  email            String              @unique
  name             String?
  createdAt        DateTime            @default(now())
  updatedAt        DateTime            @updatedAt

  // Relation fields (The "opposite" sides)
  enrollments      ProgramEnrollment[]
  workoutLogs      WorkoutLog[]
  metrics          UserMetrics[]
  userAchievements UserAchievement[]

  @@map("users")
}

model Program {
  id          String              @id @default(uuid())
  title       String
  description String?
  enrollments ProgramEnrollment[]

  @@map("programs")
}

model Exercise {
  id          String       @id @default(uuid())
  name        String
  category    String
  logs        WorkoutLog[]

  @@map("exercises")
}

// ============================================
// PROGRAM & ENROLLMENT
// ============================================

model ProgramEnrollment {
  id            String    @id @default(uuid())
  userId        String
  programId     String
  startDate     DateTime  @default(now())
  currentWeek   Int       @default(1)
  currentDay    Int       @default(1)
  completedDays Int       @default(0)
  isActive      Boolean   @default(true)
  completedAt   DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  program Program @relation(fields: [programId], references: [id], onDelete: Cascade)

  @@unique([userId, programId])
  @@index([userId])
  @@index([isActive])
  @@map("program_enrollments")
}

// ============================================
// WORKOUT TRACKING & PROGRESS
// ============================================

model WorkoutLog {
  id             String   @id @default(uuid())
  userId         String
  exerciseId     String
  date           DateTime @default(now())
  duration       Int // in seconds
  sets           Int?
  reps           Int?
  caloriesBurned Float?
  heartRate      Int?
  difficulty     String?
  notes          String?
  completed      Boolean  @default(true)
  createdAt      DateTime @default(now())

  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  exercise Exercise @relation(fields: [exerciseId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([date])
  @@index([exerciseId])
  @@map("workout_logs")
}

model UserMetrics {
  id               String   @id @default(uuid())
  userId           String
  date             DateTime @default(now())
  weight           Float? // kg
  bodyFat          Float? // percentage
  muscleMass       Float? // kg
  bmi              Float?
  restingHeartRate Int?
  notes            String?
  createdAt        DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([date])
  @@map("user_metrics")
}

// ============================================
// GAMIFICATION
// ============================================

model Achievement {
  id          String   @id @default(uuid())
  name        String   @unique
  description String
  icon        String
  category    String // STREAK, MILESTONE, EXERCISE, PROGRAM
  requirement Json // flexible JSON for conditions
  points      Int      @default(0)
  createdAt   DateTime @default(now())

  users UserAchievement[]

  @@map("achievements")
}

model UserAchievement {
  id            String   @id @default(uuid())
  userId        String
  achievementId String
  unlockedAt    DateTime @default(now())

  user        User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  achievement Achievement @relation(fields: [achievementId], references: [id], onDelete: Cascade)

  @@unique([userId, achievementId])
  @@index([userId])
  @@map("user_achievements")
}

model Streak {
  id              String    @id @default(uuid())
  userId          String    @unique
  currentStreak   Int       @default(0)
  longestStreak   Int       @default(0)
  lastWorkoutDate DateTime?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@map("streaks")
}

// ============================================
// ANALYTICS & REPORTING
// ============================================

model DailyStats {
  id            String   @id @default(uuid())
  date          DateTime @unique @default(now())
  totalUsers    Int      @default(0)
  activeUsers   Int      @default(0)
  newUsers      Int      @default(0)
  totalWorkouts Int      @default(0)
  revenue       Float    @default(0)
  createdAt     DateTime @default(now())

  @@index([date])
  @@map("daily_stats")
}
