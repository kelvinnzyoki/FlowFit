generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "rhel-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// CORE USER & AUTH MODELS
// ============================================

model User {
  id               String              @id @default(uuid())
  email            String              @unique
  password         String              // FIXED: Resolves auth.routes.ts error
  name             String?
  role             String              @default("USER") // FIXED: Resolves user.routes.ts error
  createdAt        DateTime            @default(now())
  updatedAt        DateTime            @updatedAt

  // Profile relation
  profile          Profile?            // FIXED: Resolves user.routes.ts error

  // Tracking & Gamification
  enrollments      ProgramEnrollment[]
  workoutLogs      WorkoutLog[]
  metrics          UserMetrics[]
  userAchievements UserAchievement[]
  
  // Subscriptions
  subscriptions    Subscription[]      // FIXED: Resolves subscription.routes.ts error
  
  // Auth
  refreshTokens    RefreshToken[]      // FIXED: Resolves auth.routes.ts error

  @@map("users")
}

model Profile {
  id     String  @id @default(uuid())
  bio    String?
  userId String  @unique
  user   User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("profiles")
}

model RefreshToken {
  id        String   @id @default(uuid())
  token     String   @unique
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  expiresAt DateTime
  createdAt DateTime @default(now())

  @@map("refresh_tokens")
}

// ============================================
// CONTENT MODELS (PROGRAMS & EXERCISES)
// ============================================

model Program {
  id            String              @id @default(uuid())
  title         String
  description   String?
  durationWeeks Int                 @default(4)  // FIXED: Resolves program.routes.ts error
  daysPerWeek   Int                 @default(3)  // FIXED: Resolves program.routes.ts error
  weeks         Int                 @default(4)  // FIXED: Resolves program.routes.ts error
  createdAt     DateTime            @default(now())
  updatedAt     DateTime            @updatedAt
  
  enrollments   ProgramEnrollment[]

  @@map("programs")
}

model Exercise {
  id             String       @id @default(uuid())
  name           String
  description    String?      // FIXED: Resolves workout.routes.ts error
  category       String
  caloriesPerMin Float        @default(0) // FIXED: Resolves progress.routes.ts error
  isActive       Boolean      @default(true) // FIXED: Resolves workout.routes.ts error
  createdAt      DateTime     @default(now())
  
  logs           WorkoutLog[]

  @@map("exercises")
}

// ============================================
// TRACKING & ENROLLMENTS
// ============================================

model ProgramEnrollment {
  id            String    @id @default(uuid())
  userId        String
  programId     String
  startDate     DateTime  @default(now())
  currentWeek   Int       @default(1)
  currentDay    Int       @default(1)
  completedDays Int       @default(0)
  isActive      Boolean   @default(true)
  completedAt   DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  program Program @relation(fields: [programId], references: [id], onDelete: Cascade)

  @@unique([userId, programId])
  @@index([userId])
  @@index([isActive])
  @@map("program_enrollments")
}

model WorkoutLog {
  id             String   @id @default(uuid())
  userId         String
  exerciseId     String
  date           DateTime @default(now())
  duration       Int      // in seconds
  sets           Int?
  reps           Int?
  caloriesBurned Float?
  heartRate      Int?
  difficulty     String?
  notes          String?
  completed      Boolean  @default(true)
  createdAt      DateTime @default(now())

  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  exercise Exercise @relation(fields: [exerciseId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([date])
  @@index([exerciseId])
  @@map("workout_logs")
}

model UserMetrics {
  id               String   @id @default(uuid())
  userId           String
  date             DateTime @default(now())
  weight           Float?   // kg
  bodyFat          Float?   // percentage
  muscleMass       Float?   // kg
  bmi              Float?
  restingHeartRate Int?
  notes            String?
  createdAt        DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([date])
  @@map("user_metrics")
}

// ============================================
// BUSINESS & GAMIFICATION
// ============================================

model Subscription {
  id        String   @id @default(uuid())
  userId    String
  plan      String   // e.g., "PRO", "FREE"
  status    String   // e.g., "ACTIVE"
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("subscriptions")
}

model Achievement {
  id          String   @id @default(uuid())
  name        String   @unique
  description String
  icon        String
  category    String   // STREAK, MILESTONE, EXERCISE, PROGRAM
  requirement Json     // flexible JSON for conditions
  points      Int      @default(0)
  createdAt   DateTime @default(now())

  users UserAchievement[]

  @@map("achievements")
}

model UserAchievement {
  id            String   @id @default(uuid())
  userId        String
  achievementId String
  unlockedAt    DateTime @default(now())

  user        User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  achievement Achievement @relation(fields: [achievementId], references: [id], onDelete: Cascade)

  @@unique([userId, achievementId])
  @@index([userId])
  @@map("user_achievements")
}

model Streak {
  id              String    @id @default(uuid())
  userId          String    @unique
  currentStreak   Int       @default(0)
  longestStreak   Int       @default(0)
  lastWorkoutDate DateTime?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@map("streaks")
}

model DailyStats {
  id            String   @id @default(uuid())
  date          DateTime @unique @default(now())
  totalUsers    Int      @default(0)
  activeUsers   Int      @default(0)
  newUsers      Int      @default(0)
  totalWorkouts Int      @default(0)
  revenue       Float    @default(0)
  createdAt     DateTime @default(now())

  @@index([date])
  @@map("daily_stats")
}
