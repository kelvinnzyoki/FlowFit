generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "rhel-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  
}

// ============================================
// CORE USER & AUTH MODELS
// ============================================

model User {
  id                String              @id @default(uuid())
  email             String              @unique
  password          String
  name              String?
  role              String              @default("USER")
  isEmailVerified   Boolean             @default(false) // FIXED: user.routes.ts error
  lastLogin         DateTime?           // FIXED: auth.routes.ts error
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt

  profile           Profile?
  enrollments       ProgramEnrollment[]
  workoutLogs       WorkoutLog[]
  metrics           UserMetrics[]
  userAchievements  UserAchievement[]
  subscriptions     Subscription[]
  refreshTokens     RefreshToken[]

  @@map("users")
}

model Profile {
  id                 String    @id @default(uuid())
  bio                String?
  firstName          String?
  lastName           String?
  dateOfBirth        DateTime?
  gender             String?   
  height             Float?    
  weight             Float?    
  targetWeight       Float?    
  fitnessGoal        String?   
  fitnessLevel       String?   
  timezone           String?   
  avatarUrl          String?   // FIXED: Resolves user.routes.ts error
  onboardingCompleted Boolean  @default(false) // PROACTIVE: Common next field
  isPublic           Boolean   @default(true)  // PROACTIVE: Common next field
  userId             String    @unique
  user               User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("profiles")
}


model RefreshToken {
  id        String   @id @default(uuid())
  token     String   @unique
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  expiresAt DateTime
  createdAt DateTime @default(now())

  @@map("refresh_tokens")
}

// ============================================
// CONTENT MODELS (PROGRAMS & EXERCISES)
// ============================================

model Program {
  id            String              @id @default(uuid())
  title         String
  description   String?
  durationWeeks Int                 @default(4)
  daysPerWeek   Int                 @default(3)
  createdAt     DateTime            @default(now())
  updatedAt     DateTime            @updatedAt
  
  enrollments   ProgramEnrollment[]
  weeks         Week[]

  @@map("programs")
}


// Add this model to satisfy the .include({ weeks: true }) in your routes
model Week {
  id          String   @id @default(uuid())
  weekNumber  Int      // FIXED: Resolves program.routes.ts sorting error
  title       String?
  programId   String
  program     Program  @relation(fields: [programId], references: [id], onDelete: Cascade)
  days        Day[]    // FIXED: Resolves the 'days' does not exist error

  @@map("weeks")
}


// Add the Day model
model Day {
  id          String   @id @default(uuid())
  dayNumber   Int      
  title       String?  
  weekId      String
  week        Week     @relation(fields: [weekId], references: [id], onDelete: Cascade)
  
  // FIXED: Your route is likely doing .include({ exercises: { include: { exercise: true } } })
  exercises   DayExercise[] 

  @@map("days")
}


// 3. Created the Join Model (DayExercise)
model DayExercise {
  id          String   @id @default(uuid())
  orderIndex  Int      // FIXED: Resolves program.routes.ts 'orderIndex' error
  dayId       String
  exerciseId  String
  
  day         Day      @relation(fields: [dayId], references: [id], onDelete: Cascade)
  exercise    Exercise @relation(fields: [exerciseId], references: [id], onDelete: Cascade) // FIXED: Resolves 'exercise' include error

  @@index([dayId])
  @@index([exerciseId])
  @@map("day_exercises")
}


model Exercise {
  id             String       @id @default(uuid())
  name           String
  description    String?      
  category       String
  caloriesPerMin Float        @default(0)
  isActive       Boolean      @default(true)
  createdAt      DateTime     @default(now())
  
  logs           WorkoutLog[]
  dayExercises   DayExercise[] // Updated

  @@map("exercises")
}

// ============================================
// TRACKING & ENROLLMENTS
// ============================================

model ProgramEnrollment {
  id            String    @id @default(uuid())
  userId        String
  programId     String
  startDate     DateTime  @default(now())
  currentWeek   Int       @default(1)
  currentDay    Int       @default(1)
  completedDays Int       @default(0)
  isActive      Boolean   @default(true)
  completedAt   DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  program Program @relation(fields: [programId], references: [id], onDelete: Cascade)

  @@unique([userId, programId])
  @@index([userId])
  @@index([isActive])
  @@map("program_enrollments")
}

model WorkoutLog {
  id             String   @id @default(uuid())
  userId         String
  exerciseId     String
  date           DateTime @default(now())
  duration       Int
  sets           Int?
  reps           Int?
  caloriesBurned Float?
  heartRate      Int?
  difficulty     String?
  notes          String?
  completed      Boolean  @default(true)
  createdAt      DateTime @default(now())

  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  exercise Exercise @relation(fields: [exerciseId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([date])
  @@index([exerciseId])
  @@map("workout_logs")
}

model UserMetrics {
  id               String   @id @default(uuid())
  userId           String
  date             DateTime @default(now())
  weight           Float?
  bodyFat          Float?
  muscleMass       Float?
  bmi              Float?
  restingHeartRate Int?
  notes            String?
  createdAt        DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([date])
  @@map("user_metrics")
}

// ============================================
// BUSINESS & SUBSCRIPTIONS
// ============================================

model Subscription {
  id                 String   @id @default(uuid())
  userId             String   @unique // FIXED: Allows subscription.routes to find by userId
  plan               String   
  status             String   
  cancelAtPeriodEnd  Boolean  @default(false) // FIXED: subscription.routes error
  user               User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  payments           Payment[] // FIXED: subscription.routes error
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  @@map("subscriptions")
}

model Payment {
  id             String       @id @default(uuid())
  subscriptionId String
  amount         Float
  currency       String       @default("USD")
  status         String
  subscription   Subscription @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)
  createdAt      DateTime     @default(now())

  @@map("payments")
}

// ============================================
// GAMIFICATION
// ============================================

model Achievement {
  id          String   @id @default(uuid())
  name        String   @unique
  description String
  icon        String
  category    String
  requirement Json
  points      Int      @default(0)
  createdAt   DateTime @default(now())

  users UserAchievement[]

  @@map("achievements")
}

model UserAchievement {
  id            String   @id @default(uuid())
  userId        String
  achievementId String
  unlockedAt    DateTime @default(now())

  user        User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  achievement Achievement @relation(fields: [achievementId], references: [id], onDelete: Cascade)

  @@unique([userId, achievementId])
  @@index([userId])
  @@map("user_achievements")
}

model Streak {
  id              String    @id @default(uuid())
  userId          String    @unique
  currentStreak   Int       @default(0)
  longestStreak   Int       @default(0)
  lastWorkoutDate DateTime?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@map("streaks")
}

model DailyStats {
  id            String   @id @default(uuid())
  date          DateTime @unique @default(now())
  totalUsers    Int      @default(0)
  activeUsers   Int      @default(0)
  newUsers      Int      @default(0)
  totalWorkouts Int      @default(0)
  revenue       Float    @default(0)
  createdAt     DateTime @default(now())

  @@index([date])
  @@map("daily_stats")
}
